{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Computer - 3D Fashion Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/TextureLoader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .game-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-header {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .game-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff0080, #ff8c00, #40e0d0);
        }
        
        .game-title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #ff0080, #ff8c00, #40e0d0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }
        
        .game-subtitle {
            font-size: 1.3rem;
            color: #a0aec0;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .game-main {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 30px;
            min-height: 800px;
        }
        
        .viewer-section {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .viewer-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        
        .viewer-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .viewer-title i {
            color: #40e0d0;
            font-size: 2.5rem;
        }
        
        #viewer3d {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .viewer-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .viewer-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .viewer-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .viewer-btn.reset {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
        }
        
        .viewer-btn.save {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        
        .wardrobe-section {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .wardrobe-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .wardrobe-title i {
            color: #ff8c00;
            font-size: 2.5rem;
        }
        
        .outfit-selector {
            margin-bottom: 25px;
        }
        
        .game-select {
            width: 100%;
            padding: 16px 20px;
            background: rgba(45, 55, 72, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .game-select:focus {
            outline: none;
            border-color: #40e0d0;
            box-shadow: 0 0 0 3px rgba(64, 224, 208, 0.2);
        }
        
        .category-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(45, 55, 72, 0.4);
            border-radius: 15px;
        }
        
        .category-tab {
            padding: 15px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            color: #a0aec0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .category-tab:hover {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            transform: translateY(-2px);
        }
        
        .category-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #40e0d0;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .category-tab i {
            font-size: 24px;
        }
        
        .clothing-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin: 20px 0;
        }
        
        .clothing-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .clothing-item-3d {
            background: rgba(45, 55, 72, 0.6);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .clothing-item-3d:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-5px);
            border-color: #40e0d0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .clothing-item-3d.equipped {
            background: rgba(56, 239, 125, 0.2);
            border-color: #38ef7d;
        }
        
        .clothing-preview {
            width: 100%;
            height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .clothing-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .clothing-info {
            text-align: center;
        }
        
        .clothing-name {
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .clothing-type {
            font-size: 12px;
            color: #a0aec0;
            background: rgba(102, 126, 234, 0.3);
            padding: 3px 10px;
            border-radius: 15px;
            display: inline-block;
        }
        
        .game-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-value {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, #ff0080, #ff8c00, #40e0d0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .status-label {
            font-size: 1.1rem;
            color: #a0aec0;
        }
        
        .character-poses {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(45, 55, 72, 0.4);
            border-radius: 15px;
        }
        
        .pose-btn {
            flex: 1;
            padding: 12px;
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .pose-btn:hover {
            background: rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .pose-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #40e0d0;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 15px;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid transparent;
            border-top: 4px solid #40e0d0;
            border-right: 4px solid #ff8c00;
            border-bottom: 4px solid #ff0080;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .character-info {
            background: rgba(45, 55, 72, 0.6);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border-left: 4px solid #40e0d0;
        }
        
        .info-title {
            color: #a0aec0;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            color: #a0aec0;
            z-index: 10;
            border-left: 4px solid #40e0d0;
        }
        
        .equipment-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
        }
        
        @media (max-width: 1400px) {
            .game-main {
                grid-template-columns: 1fr;
            }
            
            #viewer3d {
                height: 500px;
            }
        }
        
        .texture-quality {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .quality-btn {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quality-btn.active {
            background: #40e0d0;
            color: black;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Encabezado del juego -->
        <div class="game-header">
            <h1 class="game-title">üï∂Ô∏è 3D FASHION STUDIO</h1>
            <p class="game-subtitle">Viste modelos 3D con tus prendas en tiempo real - Sistema avanzado de texturizado</p>
        </div>
        
        <!-- Contenido principal -->
        <div class="game-main">
            <!-- Visor 3D -->
            <div class="viewer-section">
                <div class="viewer-title">
                    <i>üëÅÔ∏è</i> Visor 3D
                </div>
                
                <div id="viewer3d">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loader"></div>
                        <h3>Cargando motor 3D...</h3>
                        <p>Inicializando WebGL y modelos</p>
                    </div>
                    <div class="controls-hint">
                        üéÆ Controles: Click + arrastra para rotar ‚Ä¢ Rueda del mouse para zoom
                    </div>
                </div>
                
                <div class="character-poses">
                    <button class="pose-btn active" data-pose="stand">üßç‚Äç‚ôÇÔ∏è Parado</button>
                    <button class="pose-btn" data-pose="walk">üö∂‚Äç‚ôÇÔ∏è Caminando</button>
                    <button class="pose-btn" data-pose="run">üèÉ‚Äç‚ôÇÔ∏è Corriendo</button>
                    <button class="pose-btn" data-pose="dance">üíÉ Bailando</button>
                </div>
                
                <div class="viewer-controls">
                    <button class="viewer-btn" id="rotateCharacter">
                        <span>üîÑ</span> Rotar Personaje
                    </button>
                    <button class="viewer-btn reset" id="resetCharacter">
                        <span>üëï</span> Desvestir Todo
                    </button>
                    <button class="viewer-btn save" id="saveOutfit3d">
                        <span>üíæ</span> Guardar en 3D
                    </button>
                </div>
                
                <div class="texture-quality">
                    <span>Calidad de texturas:</span>
                    <button class="quality-btn active" data-quality="low">Baja</button>
                    <button class="quality-btn" data-quality="medium">Media</button>
                    <button class="quality-btn" data-quality="high">Alta</button>
                </div>
            </div>
            
            <!-- Armario y controles -->
            <div class="wardrobe-section">
                <div class="wardrobe-title">
                    <i>üëï</i> Armario 3D
                </div>
                
                <!-- Selector de outfit -->
                <div class="outfit-selector">
                    <select id="outfit-select" class="game-select">
                        <option value="">Cargando outfits 3D...</option>
                    </select>
                </div>
                
                <!-- Categor√≠as -->
                <div class="category-tabs">
                    <button class="category-tab active" data-category="all">
                        <i>üéØ</i> Todos
                    </button>
                    <button class="category-tab" data-category="upper">
                        <i>üëö</i> Superior
                    </button>
                    <button class="category-tab" data-category="lower">
                        <i>üëñ</i> Inferior
                    </button>
                    <button class="category-tab" data-category="shoes">
                        <i>üëü</i> Calzado
                    </button>
                </div>
                
                <!-- Lista de prendas -->
                <div class="clothing-scroll">
                    <div id="wardrobeGrid3d" class="clothing-grid">
                        <!-- Las prendas se cargar√°n aqu√≠ -->
                    </div>
                </div>
                
                <!-- Informaci√≥n del personaje -->
                <div class="character-info">
                    <div class="info-title">üë§ Modelo 3D Activo</div>
                    <div class="info-value" id="characterModel">Modelo Est√°ndar</div>
                </div>
            </div>
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="game-status">
            <div class="status-card">
                <div class="status-value" id="polygonCount">12.5K</div>
                <div class="status-label">Pol√≠gonos</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="textureCount">8</div>
                <div class="status-label">Texturas</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="fpsCounter">60</div>
                <div class="status-label">FPS</div>
            </div>
        </div>
    </div>

    <script>
        // Variables principales del sistema 3D
        let scene, camera, renderer, controls, character, mixer, clock;
        let currentAnimation = null;
        let outfitsData = [];
        let currentOutfit = null;
        let currentCategory = 'all';
        let equippedTextures = {};
        let characterParts = {};
        let textureQuality = 'medium';
        
        // Materiales base del personaje
        const characterMaterials = {
            body: null,
            upper: null,
            lower: null,
            shoes: null
        };
        
        // Modelos 3D disponibles
        const characterModels = {
            standard: {
                body: null,
                parts: ['body', 'upper', 'lower', 'shoes']
            }
        };
        
        // Inicializar el sistema 3D
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando motor 3D...');
            init3DViewer();
            loadOutfits();
            setup3DControls();
        });
        
        // Inicializar Three.js
        function init3DViewer() {
            const container = document.getElementById('viewer3d');
            
            // 1. Crear escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a);
            scene.fog = new THREE.Fog(0x0a0a1a, 10, 100);
            
            // 2. Crear c√°mara
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 3);
            
            // 3. Crear renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            
            container.appendChild(renderer.domElement);
            
            // 4. Controles de √≥rbita
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1;
            controls.maxDistance = 10;
            controls.maxPolarAngle = Math.PI / 2;
            
            // 5. Reloj para animaciones
            clock = new THREE.Clock();
            
            // 6. Configurar luces
            setupLights();
            
            // 7. Cargar modelo del personaje
            loadCharacterModel();
            
            // 8. Configurar escenario
            setupEnvironment();
            
            // 9. Iniciar loop de renderizado
            animate();
            
            // 10. Manejar resize
            window.addEventListener('resize', onWindowResize);
        }
        
        // Configurar iluminaci√≥n
        function setupLights() {
            // Luz ambiental
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // Luz direccional principal (sol)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 10, 7);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Luz de relleno
            const fillLight = new THREE.DirectionalLight(0x6699ff, 0.3);
            fillLight.position.set(-5, 3, -5);
            scene.add(fillLight);
            
            // Luz de acento
            const accentLight = new THREE.PointLight(0xff9900, 0.5, 20);
            accentLight.position.set(0, 3, 5);
            scene.add(accentLight);
        }
        
        // Cargar modelo 3D del personaje
        function loadCharacterModel() {
            // Crear geometr√≠as b√°sicas para el personaje (m√°s adelante podemos cargar GLTF)
            createBasicCharacter();
            
            // Ocultar loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 1000);
        }
        
        // Crear personaje b√°sico con geometr√≠as
        function createBasicCharacter() {
            // Grupo para el personaje
            character = new THREE.Group();
            
            // Cuerpo (torso)
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.4, 1.2, 16);
            characterMaterials.body = new THREE.MeshStandardMaterial({ 
                color: 0xffcc99,
                roughness: 0.8,
                metalness: 0.2
            });
            const body = new THREE.Mesh(bodyGeometry, characterMaterials.body);
            body.position.y = 0.6;
            body.castShadow = true;
            characterParts.body = body;
            character.add(body);
            
            // Parte superior (para camisas/chaquetas)
            const upperGeometry = new THREE.CylinderGeometry(0.35, 0.4, 0.8, 16);
            characterMaterials.upper = new THREE.MeshStandardMaterial({ 
                color: 0x888888,
                roughness: 0.9,
                transparent: true,
                opacity: 0
            });
            const upper = new THREE.Mesh(upperGeometry, characterMaterials.upper);
            upper.position.y = 0.8;
            upper.castShadow = true;
            characterParts.upper = upper;
            character.add(upper);
            
            // Parte inferior (para pantalones)
            const lowerGeometry = new THREE.CylinderGeometry(0.4, 0.35, 0.8, 16);
            characterMaterials.lower = new THREE.MeshStandardMaterial({ 
                color: 0x444444,
                roughness: 0.9,
                transparent: true,
                opacity: 0
            });
            const lower = new THREE.Mesh(lowerGeometry, characterMaterials.lower);
            lower.position.y = 0.2;
            lower.castShadow = true;
            characterParts.lower = lower;
            character.add(lower);
            
            // Zapatos
            const shoeGeometry = new THREE.BoxGeometry(0.2, 0.1, 0.4);
            characterMaterials.shoes = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                roughness: 0.8
            });
            
            // Zapato izquierdo
            const leftShoe = new THREE.Mesh(shoeGeometry, characterMaterials.shoes);
            leftShoe.position.set(-0.15, -0.15, 0.1);
            leftShoe.castShadow = true;
            
            // Zapato derecho
            const rightShoe = new THREE.Mesh(shoeGeometry, characterMaterials.shoes);
            rightShoe.position.set(0.15, -0.15, 0.1);
            rightShoe.castShadow = true;
            
            characterParts.shoes = new THREE.Group();
            characterParts.shoes.add(leftShoe, rightShoe);
            character.add(characterParts.shoes);
            
            // Cabeza
            const headGeometry = new THREE.SphereGeometry(0.25, 32, 32);
            const headMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xffcc99,
                roughness: 0.8
            });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.4;
            head.castShadow = true;
            character.add(head);
            
            // Brazos
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.7, 8);
            const armMaterial = new THREE.MeshStandardMaterial({ color: 0xffcc99 });
            
            // Brazo izquierdo
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.4, 0.8, 0);
            leftArm.rotation.z = Math.PI / 6;
            leftArm.castShadow = true;
            character.add(leftArm);
            
            // Brazo derecho
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.4, 0.8, 0);
            rightArm.rotation.z = -Math.PI / 6;
            rightArm.castShadow = true;
            character.add(rightArm);
            
            // Piernas
            const legGeometry = new THREE.CylinderGeometry(0.12, 0.12, 0.8, 8);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0xffcc99 });
            
            // Pierna izquierda
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.15, -0.2, 0);
            leftLeg.castShadow = true;
            character.add(leftLeg);
            
            // Pierna derecha
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.15, -0.2, 0);
            rightLeg.castShadow = true;
            character.add(rightLeg);
            
            // A√±adir personaje a la escena
            scene.add(character);
            
            // Actualizar estad√≠sticas
            updateStats();
        }
        
        // Configurar el entorno
        function setupEnvironment() {
            // Piso
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222233,
                roughness: 0.8,
                metalness: 0.2
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Grid helper
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            // Ejes helper
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
        }
        
        // Cargar outfits
        function loadOutfits() {
            const select = document.getElementById('outfit-select');
            
            fetch('/api/obtener-recomendaciones/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.recomendaciones && data.recomendaciones.length > 0) {
                        outfitsData = data.recomendaciones;
                        
                        select.innerHTML = '<option value="">Selecciona un outfit 3D</option>';
                        
                        outfitsData.forEach((outfit, index) => {
                            const option = document.createElement('option');
                            option.value = outfit.id;
                            option.textContent = `${outfit.nombre || `Outfit ${index + 1}`}`;
                            if (outfit.total_prendas) {
                                option.textContent += ` (${outfit.total_prendas} prendas)`;
                            }
                            select.appendChild(option);
                        });
                        
                        // Cargar primer outfit
                        if (outfitsData.length > 0) {
                            select.value = outfitsData[0].id;
                            load3DOutfit();
                        }
                    } else {
                        showEmptyWardrobe3D();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error cargando outfits 3D:', error);
                });
        }
        
        // Cargar outfit en 3D
        function load3DOutfit() {
            const outfitId = document.getElementById('outfit-select').value;
            
            if (!outfitId) return;
            
            currentOutfit = outfitsData.find(o => o.id == outfitId);
            
            if (!currentOutfit) return;
            
            console.log('üéÆ Cargando outfit 3D:', currentOutfit);
            
            // Mostrar prendas
            display3DClothes();
            
            // Resetear texturas
            resetTextures();
        }
        
        // Mostrar prendas en 3D
        function display3DClothes() {
            const grid = document.getElementById('wardrobeGrid3d');
            
            if (!currentOutfit || !currentOutfit.prendas || currentOutfit.prendas.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #a0aec0;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üëï</div>
                        <h3>Outfit vac√≠o</h3>
                        <p>Este outfit no tiene prendas para 3D</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let filteredClothes = currentOutfit.prendas;
            
            // Filtrar por categor√≠a
            if (currentCategory !== 'all') {
                filteredClothes = currentOutfit.prendas.filter(prenda => {
                    const category = getClothingCategory3D(prenda.tipo);
                    return category === currentCategory;
                });
            }
            
            filteredClothes.forEach((prenda, index) => {
                const category = getClothingCategory3D(prenda.tipo);
                const categoryIcon = getCategoryIcon3D(category);
                const isEquipped = equippedTextures[category]?.index === index;
                
                html += `
                    <div class="clothing-item-3d ${isEquipped ? 'equipped' : ''}" 
                         data-index="${index}"
                         data-category="${category}"
                         onclick="applyTextureToCharacter(${index}, '${category}')">
                        ${isEquipped ? '<div class="equipment-badge">EQUIPADO</div>' : ''}
                        <div class="clothing-preview">
                            <img src="${prenda.imagen_url}" 
                                 alt="${prenda.tipo}"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 200 200\"><rect width=\"200\" height=\"200\" fill=\"%232d3748\" rx=\"10\"/><text x=\"100\" y=\"100\" text-anchor=\"middle\" fill=\"%23a0aec0\" font-family=\"Arial\" font-size=\"14\" dy=\"0.3em\">${prenda.tipo}</text></svg>'">
                        </div>
                        <div class="clothing-info">
                            <div class="clothing-name">${prenda.tipo}</div>
                            <div class="clothing-type">${categoryIcon} ${getCategoryName3D(category)}</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // Obtener categor√≠a 3D de la prenda
        function getClothingCategory3D(tipo) {
            const tipoLower = tipo.toLowerCase();
            
            if (tipoLower.includes('camisa') || tipoLower.includes('blusa') || 
                tipoLower.includes('su√©ter') || tipoLower.includes('chaqueta') ||
                tipoLower.includes('abrigo') || tipoLower.includes('playera') ||
                tipoLower.includes('polo') || tipoLower.includes('sudadera')) {
                return 'upper';
            }
            else if (tipoLower.includes('pantal√≥n') || tipoLower.includes('pantalon') ||
                     tipoLower.includes('short') || tipoLower.includes('falda') ||
                     tipoLower.includes('jeans') || tipoLower.includes('leggings')) {
                return 'lower';
            }
            else if (tipoLower.includes('zapato') || tipoLower.includes('tenis') ||
                     tipoLower.includes('bota') || tipoLower.includes('sandalia') ||
                     tipoLower.includes('calzado')) {
                return 'shoes';
            }
            else {
                return 'upper'; // Por defecto
            }
        }
        
        // Obtener icono de categor√≠a
        function getCategoryIcon3D(category) {
            const icons = {
                'upper': 'üëö',
                'lower': 'üëñ',
                'shoes': 'üëü'
            };
            return icons[category] || 'üëï';
        }
        
        // Obtener nombre de categor√≠a
        function getCategoryName3D(category) {
            const names = {
                'upper': 'Superior',
                'lower': 'Inferior',
                'shoes': 'Calzado'
            };
            return names[category] || 'Prenda';
        }
        
        // Aplicar textura al personaje
        function applyTextureToCharacter(index, category) {
            if (!currentOutfit || !currentOutfit.prendas[index]) return;
            
            const prenda = currentOutfit.prendas[index];
            const textureLoader = new THREE.TextureLoader();
            
            // Cargar textura de la prenda
            textureLoader.load(prenda.imagen_url, function(texture) {
                // Configurar textura seg√∫n calidad
                configureTexture(texture);
                
                // Aplicar al material correspondiente
                if (category === 'upper' && characterMaterials.upper) {
                    characterMaterials.upper.map = texture;
                    characterMaterials.upper.needsUpdate = true;
                    characterMaterials.upper.opacity = 1;
                    characterMaterials.upper.transparent = true;
                    equippedTextures.upper = { index, texture, prenda };
                }
                else if (category === 'lower' && characterMaterials.lower) {
                    characterMaterials.lower.map = texture;
                    characterMaterials.lower.needsUpdate = true;
                    characterMaterials.lower.opacity = 1;
                    characterMaterials.lower.transparent = true;
                    equippedTextures.lower = { index, texture, prenda };
                }
                else if (category === 'shoes' && characterMaterials.shoes) {
                    characterMaterials.shoes.map = texture;
                    characterMaterials.shoes.needsUpdate = true;
                    equippedTextures.shoes = { index, texture, prenda };
                }
                
                // Actualizar display
                display3DClothes();
                updateStats();
                
                console.log(`‚úÖ Textura aplicada: ${prenda.tipo} en ${category}`);
            }, undefined, function(error) {
                console.error('‚ùå Error cargando textura:', error);
            });
        }
        
        // Configurar textura seg√∫n calidad
        function configureTexture(texture) {
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            
            switch(textureQuality) {
                case 'low':
                    texture.minFilter = THREE.LinearFilter;
                    texture.magFilter = THREE.LinearFilter;
                    texture.generateMipmaps = false;
                    break;
                case 'medium':
                    texture.minFilter = THREE.LinearMipmapLinearFilter;
                    texture.magFilter = THREE.LinearFilter;
                    texture.generateMipmaps = true;
                    break;
                case 'high':
                    texture.minFilter = THREE.LinearMipmapLinearFilter;
                    texture.magFilter = THREE.LinearFilter;
                    texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                    texture.generateMipmaps = true;
                    break;
            }
            
            texture.needsUpdate = true;
        }
        
        // Resetear todas las texturas
        function resetTextures() {
            // Resetear materiales
            if (characterMaterials.upper) {
                characterMaterials.upper.map = null;
                characterMaterials.upper.opacity = 0;
                characterMaterials.upper.needsUpdate = true;
            }
            
            if (characterMaterials.lower) {
                characterMaterials.lower.map = null;
                characterMaterials.lower.opacity = 0;
                characterMaterials.lower.needsUpdate = true;
            }
            
            if (characterMaterials.shoes) {
                characterMaterials.shoes.map = null;
                characterMaterials.shoes.needsUpdate = true;
            }
            
            // Limpiar texturas equipadas
            equippedTextures = {};
            
            // Actualizar display
            display3DClothes();
            updateStats();
        }
        
        // Configurar controles 3D
        function setup3DControls() {
            // Selector de outfit
            document.getElementById('outfit-select').addEventListener('change', load3DOutfit);
            
            // Pesta√±as de categor√≠as
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    display3DClothes();
                });
            });
            
            // Botones de poses
            document.querySelectorAll('.pose-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.pose-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // Aqu√≠ ir√≠a la l√≥gica para cambiar animaciones
                });
            });
            
            // Bot√≥n rotar personaje
            document.getElementById('rotateCharacter').addEventListener('click', function() {
                if (character) {
                    character.rotation.y += Math.PI / 4;
                }
            });
            
            // Bot√≥n desvestir
            document.getElementById('resetCharacter').addEventListener('click', resetTextures);
            
            // Bot√≥n guardar outfit 3D
            document.getElementById('saveOutfit3d').addEventListener('click', save3DOutfit);
            
            // Botones de calidad
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    textureQuality = this.dataset.quality;
                    
                    // Reaplicar texturas con nueva calidad
                    Object.values(equippedTextures).forEach(item => {
                        if (item.texture) {
                            configureTexture(item.texture);
                        }
                    });
                });
            });
        }
        
        // Guardar outfit 3D
        function save3DOutfit() {
            const equippedCount = Object.keys(equippedTextures).length;
            
            if (equippedCount === 0) {
                alert('üéÆ ¬°Viste al personaje primero! Selecciona algunas prendas.');
                return;
            }
            
            // Capturar screenshot del modelo
            const screenshot = renderer.domElement.toDataURL('image/png');
            
            const outfitName = prompt('üíæ Nombre para el outfit 3D:', 
                `3D Outfit ${new Date().toLocaleDateString()}`);
            
            if (!outfitName) return;
            
            // Aqu√≠ podr√≠as enviar los datos al servidor
            const outfitData = {
                name: outfitName,
                textures: Object.entries(equippedTextures).map(([category, item]) => ({
                    category,
                    prenda: item.prenda.tipo,
                    image: item.prenda.imagen_url
                })),
                screenshot: screenshot,
                timestamp: new Date().toISOString()
            };
            
            console.log('üíæ Guardando outfit 3D:', outfitData);
            
            // Crear enlace de descarga para el screenshot
            const link = document.createElement('a');
            link.href = screenshot;
            link.download = `outfit-3d-${Date.now()}.png`;
            link.click();
            
            alert(`‚úÖ Outfit 3D "${outfitName}" guardado!\nüì∏ Screenshot descargado.`);
        }
        
        // Mostrar armario vac√≠o
        function showEmptyWardrobe3D() {
            const grid = document.getElementById('wardrobeGrid3d');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #a0aec0;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üéÆ</div>
                    <h3>Sin datos 3D</h3>
                    <p>Crea algunos outfits primero</p>
                </div>
            `;
        }
        
        // Actualizar estad√≠sticas
        function updateStats() {
            // Contar pol√≠gonos (aproximado)
            let polygonCount = 0;
            scene.traverse(object => {
                if (object.isMesh) {
                    polygonCount += object.geometry.attributes.position.count / 3;
                }
            });
            document.getElementById('polygonCount').textContent = Math.round(polygonCount / 1000) + 'K';
            
            // Contar texturas
            const textureCount = Object.keys(equippedTextures).length;
            document.getElementById('textureCount').textContent = textureCount;
        }
        
        // Loop de animaci√≥n
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            
            // Actualizar controles
            if (controls) controls.update();
            
            // Actualizar animaciones
            if (mixer) mixer.update(delta);
            
            // Rotaci√≥n suave del personaje
            if (character) {
                character.rotation.y += 0.001;
            }
            
            // Actualizar FPS
            updateFPS(delta);
            
            // Renderizar
            renderer.render(scene, camera);
        }
        
        // Actualizar contador FPS
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 60;
        
        function updateFPS(delta) {
            frameCount++;
            const currentTime = performance.now();
            
            if (currentTime >= lastTime + 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fpsCounter').textContent = fps;
                frameCount = 0;
                lastTime = currentTime;
            }
        }
        
        // Manejar resize de ventana
        function onWindowResize() {
            const container = document.getElementById('viewer3d');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Manejar cambio de calidad de textura
        function changeTextureQuality(quality) {
            textureQuality = quality;
            
            // Reconfigurar texturas existentes
            Object.values(equippedTextures).forEach(item => {
                if (item.texture) {
                    configureTexture(item.texture);
                }
            });
        }
    </script>
</body>
</html>